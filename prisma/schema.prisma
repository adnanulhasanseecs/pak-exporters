// Prisma schema for Pak-Exporters B2B Marketplace
// Generated based on existing TypeScript types

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// User model
model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String
  password        String   // hashed password
  role            String   // buyer, supplier, admin, publisher
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id])
  avatar          String?
  membershipStatus String? // pending, approved, rejected, null
  membershipTier  String? // platinum, gold, silver, starter
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  rfqs            RFQ[]    // RFQs created by buyer
  rfqResponses    RFQResponse[] // RFQ responses by supplier
  membershipApplications MembershipApplication[]
  
  @@index([email])
  @@index([role])
}

// Category model
model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  image       String?
  icon        String?
  parentId    String?
  parent      Category? @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  productCount Int      @default(0)
  level       Int       @default(0)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  products    Product[]
  rfqs        RFQ[]
  companyCategories CompanyCategory[]
  
  @@index([slug])
  @@index([parentId])
}

// Company/Supplier model
model Company {
  id              String    @id @default(cuid())
  name            String
  description     String
  logo            String?
  coverImage      String?
  verified        Boolean   @default(false)
  goldSupplier    Boolean   @default(false)
  membershipTier   String?   // platinum, gold, silver, starter
  trustScore      Int?
  city            String
  province        String
  country         String    @default("Pakistan")
  email           String    @unique
  phone           String?
  website         String?
  yearEstablished Int?
  employeeCount   String?
  productCount    Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  users           User[]
  products        Product[]
  companyCategories CompanyCategory[]
  
  // JSON fields stored as text (SQLite limitation)
  certifications  String? // JSON array as string
  mainProducts    String? // JSON array as string
  
  @@index([verified])
  @@index([goldSupplier])
  @@index([membershipTier])
}

// Company-Category many-to-many relationship
model CompanyCategory {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([companyId, categoryId])
  @@index([companyId])
  @@index([categoryId])
}

// Product model
model Product {
  id              String   @id @default(cuid())
  name            String
  description     String
  shortDescription String?
  priceAmount     Float
  priceCurrency   String   @default("USD")
  minOrderQuantity Int?
  images          String   // JSON array as string (SQLite limitation)
  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id])
  companyId      String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  specifications String?  // JSON object as string
  tags            String?  // JSON array as string
  status          String   @default("active") // active, inactive, pending
  salesData       String?  // JSON object as string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([categoryId])
  @@index([companyId])
  @@index([status])
  @@index([name])
}

// RFQ (Request for Quotation) model
model RFQ {
  id            String   @id @default(cuid())
  title         String
  description   String
  buyerId       String
  buyer         User     @relation(fields: [buyerId], references: [id])
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id])
  quantityMin   Float?
  quantityMax   Float?
  quantityUnit  String?
  budgetMin     Float?
  budgetMax     Float?
  budgetCurrency String? @default("USD")
  specifications String? // JSON object as string
  attachments   String?  // JSON array as string
  status        String   @default("open") // open, closed, awarded, cancelled
  deadline      DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  responses     RFQResponse[]
  
  @@index([buyerId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
}

// RFQ Response model
model RFQResponse {
  id          String   @id @default(cuid())
  rfqId       String
  rfq         RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierId  String
  supplier    User     @relation(fields: [supplierId], references: [id])
  supplierCompany String
  priceAmount Float
  priceCurrency String @default("USD")
  message     String?
  status      String   @default("pending") // pending, accepted, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([rfqId])
  @@index([supplierId])
  @@index([status])
}

// Blog/News model
model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String
  excerpt     String?
  author      String?
  image       String?
  published   Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([published])
  @@index([publishedAt])
}

// Membership Application model
model MembershipApplication {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  companyName   String
  companyDescription String
  requestedTier String   // platinum, gold, silver, starter
  status        String   @default("pending") // pending, approved, rejected
  adminNotes    String?
  reviewedAt    DateTime?
  reviewedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
}
